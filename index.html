<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Avis clients</title>

<script src="https://www.google.com/recaptcha/api.js?render=6LdhzFgsAAAAAM94cbBwznlazTvLxnOyHxSiekZ"></script>

<style>
body{font-family:system-ui;background:#0e1117;color:#fff}
.container{max-width:800px;margin:auto;padding:20px}
.comment-card{background:#161b22;padding:15px;border-radius:10px;margin-bottom:10px}
.stars span{cursor:pointer;font-size:22px;color:#444}
.stars span.active{color:#ffc107}
</style>
</head>

<body>
<div class="container">
<h2>ðŸ’¬ Avis clients</h2>

<form id="comment-form">
<input id="username" placeholder="Votre nom" required><br><br>

<div class="stars">
<span data-value="1">â˜…</span>
<span data-value="2">â˜…</span>
<span data-value="3">â˜…</span>
<span data-value="4">â˜…</span>
<span data-value="5">â˜…</span>
</div>

<input type="hidden" id="rating">
<input type="text" id="website" style="display:none">

<br>
<textarea id="comment" placeholder="Votre commentaire" required></textarea><br><br>
<button type="submit">Publier</button>
</form>

<div id="comments-list"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getFirestore, collection, addDoc,
  serverTimestamp, query, orderBy, limit, getDocs
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdo7NO1PnAa90PhEhuzpllkB1ESGZu3J8",
  authDomain: "harry-undersand.firebaseapp.com",
  projectId: "harry-undersand"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let selectedRating = 0;

document.querySelectorAll(".stars span").forEach(star=>{
  star.onclick = ()=>{
    selectedRating = Number(star.dataset.value);
    rating.value = selectedRating;
    document.querySelectorAll(".stars span")
      .forEach(s=>s.classList.toggle("active", s.dataset.value<=selectedRating));
  };
});

comment-form.onsubmit = async e => {
  e.preventDefault();
  if (website.value !== "") return;
  if (!selectedRating) return alert("Choisissez une note");

  grecaptcha.ready(()=>{
    grecaptcha.execute("6LdhzFgsAAAAAM94cbBwznlazTvLxnOyHxSiekZ",{action:"comment"})
    .then(async token=>{
      const res = await fetch("/api/verify-recaptcha",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          token,
          name:username.value,
          text:comment.value,
          rating:selectedRating
        })
      });

      const data = await res.json();
      if (!data.success) return alert("Spam dÃ©tectÃ©");

      await addDoc(collection(db,"comments"),{
        name:username.value,
        text:comment.value,
        rating:selectedRating,
        createdAt:serverTimestamp()
      });

      comment-form.reset();
      selectedRating = 0;
      loadComments();
    });
  });
};

async function loadComments(){
  comments-list.innerHTML="";
  const q=query(collection(db,"comments"),orderBy("createdAt","desc"),limit(5));
  const snap=await getDocs(q);
  snap.forEach(d=>{
    const c=d.data();
    comments-list.innerHTML+=`
      <div class="comment-card">
        <strong>${c.name}</strong><br>
        ${"â˜…".repeat(c.rating)}${"â˜†".repeat(5-c.rating)}
        <p>${c.text}</p>
      </div>`;
  });
}
loadComments();
</script>
</body>
</html>
