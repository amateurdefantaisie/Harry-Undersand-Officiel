<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>WhatsApp Clone – Firebase (Final)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:Arial;background:#0b141a;color:white;height:100vh;display:flex}
    .login{width:100%;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .app{width:100%;display:none}
    .sidebar{width:30%;background:#111b21;padding:10px;overflow-y:auto}
    .chat{width:70%;display:flex;flex-direction:column}
    .chat-header{padding:10px;background:#202c33}
    .messages{flex:1;padding:10px;overflow-y:auto}
    .msg{padding:8px;margin:5px 0;border-radius:6px;max-width:60%}
    .me{background:#005c4b;margin-left:auto}
    .other{background:#202c33}
    .input{display:flex;padding:10px;background:#202c33}
    .input input{flex:1;padding:10px;border-radius:20px;border:none}
    .input button{margin-left:10px;border:none;border-radius:20px;background:#00a884;color:white;padding:10px 20px}
    .conv{padding:10px;border-bottom:1px solid #2a3942;cursor:pointer}
    .conv:hover{background:#202c33}
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login" id="login">
  <h2>Connexion</h2>
  <input id="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Mot de passe" />
  <button onclick="login()">Connexion</button>
</div>

<!-- APP -->
<div class="app" id="app">
  <div class="sidebar">
    <h3>Discussions</h3>
    <div id="conversations"></div>
  </div>
  <div class="chat">
    <div class="chat-header" id="chatName">Sélectionne une discussion</div>
    <div class="messages" id="messages"></div>
    <div class="input">
      <input id="text" placeholder="Message..." />
      <button onclick="sendMessage()">Envoyer</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyBdo7NO1PnAa90PhEhuzpllkB1ESGZu3J8",
  authDomain:"harry-undersand.firebaseapp.com",
  projectId:"harry-undersand"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();
let currentConversation=null;

const loginDiv=document.getElementById('login');
const appDiv=document.getElementById('app');
const messagesDiv=document.getElementById('messages');
const convDiv=document.getElementById('conversations');
const chatName=document.getElementById('chatName');

auth.onAuthStateChanged(user=>{
  if(user){loginDiv.style.display='none';appDiv.style.display='flex';saveUser();loadConversations();}
  else{loginDiv.style.display='flex';appDiv.style.display='none';}
});

function login(){auth.signInWithEmailAndPassword(email.value,password.value)}

function saveUser(){
  const u=auth.currentUser;
  db.collection('users').doc(u.uid).set({
    email:u.email,
    online:true
  },{merge:true});
}

function loadConversations(){
  db.collection('conversations')
    .where('members','array-contains',auth.currentUser.uid)
    .onSnapshot(snap=>{
      convDiv.innerHTML='';
      snap.forEach(doc=>{
        const c=doc.data();
        const div=document.createElement('div');
        div.className='conv';
        div.textContent=c.lastMessage||'Nouvelle discussion';
        div.onclick=()=>openConversation(doc.id);
        convDiv.appendChild(div);
      });
    });
}

function openConversation(id){
  currentConversation=id;
  messagesDiv.innerHTML='';
  listenMessages();
}

function listenMessages(){
  db.collection('messages')
    .where('conversationId','==',currentConversation)
    .orderBy('created')
    .onSnapshot(snap=>{
      messagesDiv.innerHTML='';
      snap.forEach(doc=>{
        const m=doc.data();
        const div=document.createElement('div');
        div.className='msg '+(m.uid===auth.currentUser.uid?'me':'other');
        div.textContent=m.text;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    });
}

async function sendMessage(){
  if(!text.value||!currentConversation)return;
  await db.collection('messages').add({
    conversationId:currentConversation,
    uid:auth.currentUser.uid,
    text:text.value,
    created:firebase.firestore.FieldValue.serverTimestamp()
  });
  await db.collection('conversations').doc(currentConversation).set({
    lastMessage:text.value,
    updated:firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
  text.value='';
}
</script>
</body>
</html>
