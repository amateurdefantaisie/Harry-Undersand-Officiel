<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harry Undersand</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{font-family:Arial;background:#0b141a;color:#fff;margin:0}
header{padding:15px;border-bottom:1px solid #333}
.auth{display:flex;gap:10px}
button{padding:10px 16px;border-radius:8px;border:none;cursor:pointer}
.primary{background:#8b5cf6;color:#fff}
.card{background:#111b21;padding:20px;border-radius:12px;margin:20px auto;max-width:600px}
.stars span{font-size:26px;cursor:pointer;color:#555}
.stars span.active{color:gold}
.comment{border-bottom:1px solid #333;padding:10px 0}
</style>
</head>

<body>

<header>
  <div class="auth" id="authGuest">
    <button id="loginBtn">Connexion Google</button>
  </div>
  <div class="auth" id="authUser" style="display:none">
    <span id="welcome"></span>
    <button id="logoutBtn">DÃ©connexion</button>
  </div>
</header>

<div class="card">
<h3>â­ Laisser un avis</h3>

<form id="commentForm">
<input id="username" placeholder="Votre nom" required><br><br>

<div class="stars">
<span data-value="1">â˜…</span>
<span data-value="2">â˜…</span>
<span data-value="3">â˜…</span>
<span data-value="4">â˜…</span>
<span data-value="5">â˜…</span>
</div>
<input type="hidden" id="rating">

<br>
<textarea id="comment" placeholder="Commentaire" required></textarea><br><br>
<button class="primary">Publier</button>
</form>
</div>

<div class="card">
<h3>ğŸ’¬ Avis</h3>
<div id="comments"></div>
</div>

<div class="card">
<h3>ğŸ“Š Visites</h3>
<p>Total : <span id="visitCount">0</span></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth, GoogleAuthProvider,
  signInWithPopup, signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore, collection, addDoc, getDocs,
  doc, setDoc, getDoc,
  serverTimestamp, increment
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdo7NO1PnAa90PhEhuzpllkB1ESGZu3J8",
  authDomain: "harry-undersand.firebaseapp.com",
  projectId: "harry-undersand"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

/* AUTH */
loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async user => {
  if (!user) {
    authGuest.style.display="flex";
    authUser.style.display="none";
    return;
  }

  authGuest.style.display="none";
  authUser.style.display="flex";
  welcome.textContent = "Bienvenue " + user.displayName;

  const ref = doc(db,"users",user.uid);
  if (!(await getDoc(ref)).exists()) {
    await setDoc(ref,{
      name:user.displayName,
      email:user.email,
      role:"user",
      blocked:false,
      createdAt:serverTimestamp()
    });
  }
});

/* â­ Ã©toiles */
const stars=document.querySelectorAll(".stars span");
stars.forEach(s=>s.onclick=()=>{
  rating.value=s.dataset.value;
  stars.forEach(x=>x.classList.toggle("active",x.dataset.value<=rating.value));
});

/* ğŸ’¬ commentaires */
commentForm.onsubmit=async e=>{
  e.preventDefault();
  if(!rating.value) return alert("Choisis une note");

  await addDoc(collection(db,"comments"),{
    name:username.value,
    text:comment.value,
    rating:Number(rating.value),
    createdAt:serverTimestamp()
  });

  commentForm.reset();
  stars.forEach(s=>s.classList.remove("active"));
  loadComments();
};

async function loadComments(){
  comments.innerHTML="";
  const snap=await getDocs(collection(db,"comments"));
  snap.forEach(d=>{
    const c=d.data();
    comments.innerHTML+=`
      <div class="comment">
        <strong>${c.name}</strong><br>
        ${"â˜…".repeat(c.rating)}
        <p>${c.text}</p>
      </div>`;
  });
}
loadComments();

/* ğŸ“Š visites */
async function registerVisit(){
  await setDoc(doc(db,"stats","global"),{
    visits:increment(1)
  },{merge:true});

  const snap=await getDoc(doc(db,"stats","global"));
  visitCount.textContent=snap.data().visits || 0;
}
registerVisit();
</script>

</body>
</html>
